Param ([string] $TileId = "S2B_31UFT_20230301_0_L2A",
    [string]$expname = "training_20241028_195657",
    [string]$source_path = "nl_ref.parquet",
    [string]$url_cadastre = "https://data.source.coop/fiboa/nl-ref/nl_ref.parquet")

# input paths to be defined by user
$project_root = "\accuracy"
$code_path = "\NIVA-model\src\other"
$pred_file_path = "\data\$expname\temporary\contours\$TileId\merged_simplified.gpkg"

$tile_path = "$project_root/$TileId/tile/$TileId.nc"
if (!(Test-Path $tile_path)) {
Write-Output "Download tile for tile_id $TileId"
python "$code_path\tile_download_by_id.py" --tile_id $TileId --project_root $project_root
}

# download cadastre data for accuracy estimations
$SubName = ($url_cadastre  -split '/')[-1]
$filename = ($SubName  -split '.')[0]
$ext = ($SubName  -split '.')[-1]
$out_file = "$project_root/$SubName"

if (!(Test-Path $out_file)) {
Write-Output "Download cadastre data from $url_cadastre"
try {
        Invoke-RestMethod -Uri $url_cadastre `
            -OutFile $out_file
    }
    catch {
        Write-Error "$url_cadastre not found."
        Exit
    }
}

if (!(Test-Path "$project_root/$source_path")) {
Write-Output "Extract .7z archive $out_file into $project_root"
# Expand-Archive -LiteralPath $out_file -DestinationPath $project_root
python "$code_path\z_extract.py" --input $out_file --output $project_root
}


$Grid = $TileId[4..8] -join ''
$GridName = "_$Grid" + "_"
$SimTolerance = 5
$cadastre_tile_path = "$project_root/$TileId/tile/$filename$GridName$SimTolerance.gpkg"
$cadastre_path = "$project_root\$source_path"
$tile_meta = "$project_root\$TileId\tile\metadata.gpkg"

if (!(Test-Path $cadastre_tile_path)) {
Write-Output "Preprocess cadastre data - saving it only for tile grid. `
Cadastre final output path for the grid $cadastre_tile_path"
python "$code_path\cadastre_preprocess.py" --cadastre_tile_path $cadastre_tile_path `
    --cadastre_path $cadastre_path --sim_tolerance $SimTolerance --tile_meta $tile_meta
}


$eopatches_folder = "$project_root/$TileId/eopatches"
# create base eopatches (folder with bbox for patches)
if (!(Test-Path $eopatches_folder)) {
Write-Output "Create basic patches for bbox definition in folder $eopatches_folder"
python "$code_path\create_patches.py" --tile_path $tile_path --eopatches_folder $eopatches_folder
}

$final_file_name = $SubName + $expname
$metrics_path = "$project_root/$TileId/metrics_$final_file_name.csv"

if (!(Test-Path $metrics_path)) {
Write-Output "Compute accuracy for the predicted $pred_file_path and cadastre $cadastre_tile_path"
python "$code_path\accuracy_computation_sim.py" --cadastre_tile_path $cadastre_tile_path `
    --eopatches_folder $eopatches_folder --pred_file_path $pred_file_path --metrics_path $metrics_path
}